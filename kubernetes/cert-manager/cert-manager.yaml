apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-token-secret
  namespace: cert-manager
type: Opaque
data:
  api-token: ${CLOUDFLARE_API_TOKEN}

---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: certificateissuer
  namespace: cert-manager
spec:
  acme:
    email: ryanwclark@yahoo.com
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-private-key
    solvers:
      - dns01:
          cloudflare:
            email: ryanwclark@yahoo.com
            apiTokenSecretRef:
              name: cloudflare-api-token-secret
              key: api-token

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cert
  namespace: cert-manager
spec:
  secretName: techcasa-tls
  issuerRef:
    name: certificateissuer
    kind: ClusterIssuer
  dnsNames:
    - '*.techcasa.io'
    - 'techcasa.io'

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-manager
  namespace: cert-manager
  labels:
    app: cert-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-manager
  template:
    metadata:
      labels:
        app: cert-manager
    spec:
      serviceAccountName: cert-manager
      containers:
      - name: cert-manager
        image: quay.io/jetstack/cert-manager-controller:v1.14.5
        args:
          - "--v=2"
          - "--cluster-resource-namespace=$(POD_NAMESPACE)"
          - "--leader-election-namespace=kube-system"
          - "--acme-http01-solver-image=quay.io/jetstack/cert-manager-acmesolver:v1.14.5"
          - "--max-concurrent-challenges=60"
          - "--enable-certificate-owner-ref=true"
          - "--dns01-recursive-nameservers=1.1.1.1:53,1.0.0.1:53"
        env:
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        ports:
          - containerPort: 9402
            name: http-metrics
            protocol: TCP
          - containerPort: 9403
            name: http-healthz
            protocol: TCP
        livenessProbe:
          failureThreshold: 8
          httpGet:
            path: /livez
            port: http-healthz
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 15
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
          - name: kube-api-access
            mountPath: /etc/kube-api-access
            readOnly: true
      volumes:
        - name: kube-api-access
          projected:
            sources:
              - serviceAccountToken:
                  path: token
                  expirationSeconds: 3607
              - configMap:
                  name: kube-root-ca.crt
                  items:
                    - key: ca.crt
                      path: ca.crt
              - downwardAPI:
                  items:
                    - path: namespace
                      fieldRef:
                        fieldPath: metadata.namespace
