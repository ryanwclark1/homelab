---
# Configure storage nodes for Longhorn

- name: Install storage prerequisites
  apt:
    name:
      - open-iscsi
      - nfs-common
      - util-linux
    state: present

- name: Create Longhorn storage directory
  file:
    path: "{{ longhorn_storage_path }}"
    state: directory
    mode: '0755'

- name: Check if additional storage disk exists
  stat:
    path: "{{ storage_disk }}"
  register: storage_disk_stat
  when: storage_disk is defined

- name: Format additional storage disk
  filesystem:
    fstype: ext4
    dev: "{{ storage_disk }}"
  when:
    - storage_disk is defined
    - storage_disk_stat.stat.exists
    - storage_disk_stat.stat.isblk is defined
    - storage_disk_stat.stat.isblk

- name: Mount additional storage disk
  mount:
    path: "{{ longhorn_storage_path }}"
    src: "{{ storage_disk }}"
    fstype: ext4
    opts: defaults
    state: mounted
  when:
    - storage_disk is defined
    - storage_disk_stat.stat.exists

- name: Label node for storage
  command: k3s kubectl label node {{ inventory_hostname }} node.longhorn.io/create-default-disk=true --overwrite
  delegate_to: "{{ groups['k3s_init_master'][0] }}"
  changed_when: true

- name: Display storage node info
  debug:
    msg: |
      Storage node configured: {{ inventory_hostname }}
      Storage path: {{ longhorn_storage_path }}
      {% if storage_disk is defined %}
      Storage disk: {{ storage_disk }}
      {% endif %}
