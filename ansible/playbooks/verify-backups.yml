---
# Backup verification playbook
# Tests that backups exist and can be restored

- name: Verify Proxmox Backups
  hosts: proxmox_cluster
  become: yes
  gather_facts: yes

  vars:
    backup_dir: /var/backups/proxmox
    min_backup_age_days: 1
    max_backup_age_days: 7

  tasks:
    - name: Check backup directory exists
      stat:
        path: "{{ backup_dir }}"
      register: backup_dir_stat

    - name: Verify backup directory
      assert:
        that:
          - backup_dir_stat.stat.exists
          - backup_dir_stat.stat.isdir
        fail_msg: "Backup directory {{ backup_dir }} does not exist!"
        success_msg: "Backup directory found"

    - name: Find recent backups
      find:
        paths: "{{ backup_dir }}"
        age: "-{{ max_backup_age_days }}d"
        recurse: yes
      register: recent_backups

    - name: Verify recent backups exist
      assert:
        that:
          - recent_backups.files | length > 0
        fail_msg: "No backups found in last {{ max_backup_age_days }} days!"
        success_msg: "Found {{ recent_backups.files | length }} recent backup(s)"

    - name: Check backup file sizes
      stat:
        path: "{{ item.path }}"
      loop: "{{ recent_backups.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      register: backup_sizes

    - name: Verify backups are not empty
      assert:
        that:
          - item.stat.size > 0
        fail_msg: "Backup {{ item.item.path }} is empty!"
        success_msg: "Backup {{ item.item.path | basename }} is {{ (item.stat.size / 1024 / 1024) | round(2) }} MB"
      loop: "{{ backup_sizes.results }}"
      loop_control:
        label: "{{ item.item.path | basename }}"

    - name: Test backup restoration (dry-run)
      shell: |
        # Test network config backup
        if [ -f "{{ backup_dir }}/interfaces.$(date +%Y-%m-%d)" ]; then
          diff "{{ backup_dir }}/interfaces.$(date +%Y-%m-%d)" /etc/network/interfaces || true
          echo "Network config backup verified"
        fi
      register: restore_test
      changed_when: false
      failed_when: false

    - name: Display backup summary
      debug:
        msg: |
          Backup verification for {{ inventory_hostname }}:
          - Directory: {{ backup_dir }}
          - Recent backups: {{ recent_backups.files | length }}
          - Total size: {{ (recent_backups.files | map(attribute='size') | sum / 1024 / 1024) | round(2) }} MB
          - Oldest: {{ recent_backups.files | map(attribute='mtime') | min | int | to_datetime('%Y-%m-%d %H:%M:%S') }}
          - Newest: {{ recent_backups.files | map(attribute='mtime') | max | int | to_datetime('%Y-%m-%d %H:%M:%S') }}

- name: Verify TrueNAS Snapshots
  hosts: truenas_servers
  gather_facts: no
  connection: local

  tasks:
    - name: Get snapshots
      uri:
        url: "{{ truenas_api_url }}/pool/dataset/id/tank/snapshots"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
      register: snapshots
      when: truenas_api_url is defined

    - name: Verify snapshots exist
      assert:
        that:
          - snapshots.json | length > 0
        fail_msg: "No snapshots found on TrueNAS!"
        success_msg: "Found {{ snapshots.json | length }} snapshot(s)"
      when: snapshots.json is defined

    - name: Display snapshot summary
      debug:
        msg: |
          Snapshots on {{ inventory_hostname }}:
          Total: {{ snapshots.json | length }}
      when: snapshots.json is defined

- name: Verify K3s Backups
  hosts: k3s_init_master
  become: yes
  gather_facts: no

  vars:
    etcd_backup_dir: /var/lib/rancher/k3s/server/db/snapshots

  tasks:
    - name: Check etcd snapshots directory
      stat:
        path: "{{ etcd_backup_dir }}"
      register: etcd_dir

    - name: Find recent etcd snapshots
      find:
        paths: "{{ etcd_backup_dir }}"
        patterns: "etcd-snapshot-*"
        age: "-7d"
      register: etcd_snapshots
      when: etcd_dir.stat.exists

    - name: Verify etcd snapshots
      assert:
        that:
          - etcd_snapshots.files | length > 0
        fail_msg: "No etcd snapshots found!"
        success_msg: "Found {{ etcd_snapshots.files | length }} etcd snapshot(s)"
      when: etcd_dir.stat.exists

    - name: Display etcd backup summary
      debug:
        msg: |
          etcd backups on {{ inventory_hostname }}:
          - Location: {{ etcd_backup_dir }}
          - Count: {{ etcd_snapshots.files | length }}
          - Latest: {{ (etcd_snapshots.files | sort(attribute='mtime', reverse=true) | first).path | basename }}
      when:
        - etcd_dir.stat.exists
        - etcd_snapshots.files | length > 0

- name: Generate Backup Report
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create backup report
      copy:
        content: |
          # Backup Verification Report
          Generated: {{ ansible_date_time.iso8601 }}

          ## Summary
          - Proxmox hosts verified: {{ groups['proxmox_cluster'] | length }}
          - TrueNAS servers verified: {{ groups['truenas_servers'] | default([]) | length }}
          - K3s etcd backups verified: Yes

          ## Next Steps
          1. Review backup logs for errors
          2. Test actual restoration on non-production system
          3. Verify offsite backup sync
          4. Update backup documentation

          ## Recommendations
          - Schedule monthly restoration tests
          - Monitor backup storage capacity
          - Automate backup verification
          - Document restoration procedures
        dest: /tmp/backup-verification-report.md
        mode: '0644'

    - name: Display report location
      debug:
        msg: "Backup verification report saved to /tmp/backup-verification-report.md"
