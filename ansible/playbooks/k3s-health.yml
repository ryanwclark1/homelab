---
# K3s cluster health check

- name: K3s Cluster Health Check
  hosts: k3s_init_master
  become: yes
  gather_facts: no

  tasks:
    - name: Get cluster nodes
      command: k3s kubectl get nodes -o wide
      register: k3s_nodes
      changed_when: false

    - name: Get pods status
      command: k3s kubectl get pods --all-namespaces
      register: k3s_pods
      changed_when: false

    - name: Get system pods
      command: k3s kubectl get pods -n kube-system
      register: k3s_system_pods
      changed_when: false

    - name: Check cluster health
      command: k3s kubectl get cs
      register: k3s_health
      changed_when: false
      failed_when: false

    - name: Display health report
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║  K3s Cluster Health Check
          ╚══════════════════════════════════════════════════════════╝

          Cluster Nodes:
          {{ k3s_nodes.stdout }}

          System Pods:
          {{ k3s_system_pods.stdout }}

    - name: Count ready nodes
      shell: k3s kubectl get nodes --no-headers | grep -c " Ready"
      register: ready_nodes
      changed_when: false

    - name: Display summary
      debug:
        msg: |
          Ready nodes: {{ ready_nodes.stdout }}/14
          Expected: 14 (6 masters + 5 workers + 3 storage)
