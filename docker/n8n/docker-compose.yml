services:

  n8n:
    image: n8nio/n8n:${N8N_TAG:-1.42.1}
    container_name: n8n
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - ./data:/home/node/.n8n
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8n}
      - DB_POSTGRESDB_USER=${N8N_DB_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - DB_POSTGRESDB_SCHEMA=public
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://n8n.example.com/}
      - GENERIC_TIMEZONE=${TZ:-Etc/UTC}
      - TZ=${TZ:-Etc/UTC}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  postgres:
    image: postgres:${POSTGRES_TAG:-16-alpine}
    container_name: n8n-postgres
    ports:
      - "${N8N_POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${N8N_DB_USER:-n8n}
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD}
      - POSTGRES_DB=${N8N_DB_NAME:-n8n}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${N8N_DB_NAME:-n8n} -U ${N8N_DB_USER:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  backup:
    image: prodrigestivill/postgres-backup-local:${POSTGRES_BACKUP_TAG:-latest}
    container_name: n8n-db-backup
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${N8N_DB_NAME:-n8n}
      - POSTGRES_USER=${N8N_DB_USER:-n8n}
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD}
      - SCHEDULE=${BACKUP_SCHEDULE:-@daily}
      - BACKUP_DIR=/db_dumps
      - BACKUP_KEEP_DAYS=${BACKUP_KEEP_DAYS:-7}
      - BACKUP_KEEP_WEEKS=${BACKUP_KEEP_WEEKS:-4}
      - BACKUP_KEEP_MONTHS=${BACKUP_KEEP_MONTHS:-6}
    volumes:
      - ./backups:/db_dumps
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
