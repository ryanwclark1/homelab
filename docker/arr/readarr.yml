services:
  readarr:
    image: lscr.io/linuxserver/readarr:${READARR_TAG:-develop}
    container_name: readarr
    security_opt:
      - no-new-privileges:true
    restart: "no"
    profiles: ["media","arrs", "all"]
    networks:
      - t3_proxy
    volumes:
      - ${COMMON_CONFIG_PATH}/readarr:/config
      - ${COMMON_DATA_PATH}:/media
    ports:
      - 8787:8787
    labels:
        - "traefik.enable=true"
        # HTTP Routers Auth Bypass
        - "traefik.http.routers.readarr-rtr-bypass.entrypoints=websecure"
        #- "traefik.http.routers.readarr-rtr-bypass.rule=Host(`readarr.$DOMAINNAME_HS`) && (Header(`X-Api-Key`, `$READARR_API_KEY`) || Query(`apikey`, `$READARR_API_KEY`))"
        - "traefik.http.routers.readarr-rtr-bypass.rule=Host(`readarr.$DOMAINNAME_HS`) && Header(`traefik-auth-bypass-key`, `$TRAEFIK_AUTH_BYPASS_KEY`)" # Bypass Auth for LunaSea on iOS
        - "traefik.http.routers.readarr-rtr-bypass.priority=100"
        # HTTP Routers Auth
        - "traefik.http.routers.readarr-rtr.entrypoints=websecure"
        - "traefik.http.routers.readarr-rtr.rule=Host(`readarr.$DOMAINNAME_HS`)"
        - "traefik.http.routers.readarr-rtr.priority=99"
        # Middlewares
        - "traefik.http.routers.readarr-rtr-bypass.middlewares=chain-no-auth@file"
        - "traefik.http.routers.readarr-rtr.middlewares=chain-oauth@file"
        # HTTP Services
        - "traefik.http.routers.readarr-rtr.service=readarr-svc"
        - "traefik.http.routers.readarr-rtr-bypass.service=readarr-svc"
        - "traefik.http.services.readarr-svc.loadbalancer.server.port=8787"