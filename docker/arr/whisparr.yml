services:
  whisparr:
    image: ghcr.io/hotio/whisparr:latest
    container_name: whisparr
    security_opt:
      - no-new-privileges:true
    restart: "no"
    profiles: ["media","arrs", "all"]
    networks:
      - t3_proxy
    ports:
      - 6969:6969
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
      - UMASK_SET=${UMASK_SET:-022}
      - WHISPARR_API_KEY=${WHISPARR_API_KEY}
      - WHISPARR_URL=${WHISPARR_URL:-https://whisparr.$DOMAINNAME_HS}
    volumes:
      - ${COMMON_CONFIG_PATH}/whisparr:/config
      - ${COMMON_DATA_PATH}:/media
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whisparr.entrypoints=web"
      - "traefik.http.routers.whisparr.rule=Host(`whisparr.$DOMAINNAME_HS`)"
      - "traefik.http.middlewares.whisparr-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.whisparr.middlewares=whisparr-https-redirect"
      - "traefik.http.routers.whisparr-secure.entrypoints=websecure"
      - "traefik.http.routers.whisparr-secure.rule=Host(`whisparr.$DOMAINNAME_HS`)"
      - "traefik.http.routers.whisparr-secure.tls=true"
      - "traefik.http.routers.whisparr-secure.tls.certresolver=cloudflare-dns"
      - "traefik.http.routers.whisparr-secure.service=whisparr"
      # - "traefik.http.services.whisparr-svc.loadbalancer.server.scheme=https"
      - "traefik.http.services.whisparr.loadbalancer.server.port=9999"
      - "traefik.docker.network=t3_proxy"

      # - "traefik.enable=true"
      # # HTTP Routers Auth Bypass
      # - "traefik.http.routers.whisparr-rtr-bypass.entrypoints=websecure"
      # - "traefik.http.routers.whisparr-rtr-bypass.rule=Host(`whisparr.$DOMAINNAME_HS`) && (Header(`X-Api-Key`, `$WHISPARR_API_KEY`) || Query(`apikey`, `$WHISPARR_API_KEY`))"
      # # - "traefik.http.routers.whisparr-rtr-bypass.rule=Host(`whisparr.$DOMAINNAME_HS`) && Header(`traefik-auth-bypass-key`, `$TRAEFIK_AUTH_BYPASS_KEY`)" # Bypass Auth for LunaSea on iOS
      # - "traefik.http.routers.whisparr-rtr-bypass.priority=100"
      # # HTTP Routers Auth
      # - "traefik.http.routers.whisparr-rtr.entrypoints=websecure"
      # - "traefik.http.routers.whisparr-rtr.rule=Host(`whisparr.$DOMAINNAME_HS`)"
      # - "traefik.http.routers.whisparr-rtr.priority=99"
      # # Middlewares
      # - "traefik.http.routers.whisparr-rtr-bypass.middlewares=chain-no-auth@file"
      # # - "traefik.http.routers.whisparr-rtr.middlewares=chain-oauth@file"
      # # HTTP Services
      # - "traefik.http.routers.whisparr-rtr.service=whisparr-svc"
      # - "traefik.http.routers.whisparr-rtr-bypass.service=whisparr-svc"
      # - "traefik.http.services.whisparr-svc.loadbalancer.server.port=6969"